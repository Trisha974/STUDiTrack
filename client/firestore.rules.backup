rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to get user role from users collection (with safe error handling)
    // OPTIMIZED: Cache role check to reduce reads - only check once per request
    // Returns null if document doesn't exist or can't be read
    function getUserRole() {
      // Only try to get role if user owns the document (can read it)
      // Use ternary operator instead of if statement
      // IMPORTANT: This get() call counts as a read, but it's necessary for security
      // We minimize its use by checking isOwner first
      return isOwner(request.auth.uid) 
        ? (exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
           ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role 
           : null)
        : null;
    }
    
    // Helper function to check if user is a student
    function isStudent() {
      return getUserRole() == 'Student';
    }
    
    // Helper function to check if user is a professor
    function isProfessor() {
      return getUserRole() == 'Professor';
    }
    
    // Helper function to check if professor teaches a course
    // OPTIMIZED: For queries, use resource.data.professorId if available (no extra read)
    // For single reads, we still need get() but minimize its use
    // Returns true if the course's professorId matches the authenticated user's UID
    function professorTeachesCourse(courseId) {
      // OPTIMIZATION: If we're reading from a query result, resource.data might have professorId
      // But for enrollments/grades/attendance, we need to check the course document
      // This get() call is necessary but expensive - consider caching professorId in documents
      return isAuthenticated() && isProfessor() &&
        exists(/databases/$(database)/documents/courses/$(courseId)) &&
        get(/databases/$(database)/documents/courses/$(courseId)).data.professorId == request.auth.uid;
    }
    
    // Helper function to check if professor teaches a course (for new documents)
    // Used when creating new records that reference a course
    // OPTIMIZED: Consider storing professorId in enrollment/grade/attendance documents
    // to avoid this get() call
    function professorTeachesCourseFromRequest(courseId) {
      return isAuthenticated() && isProfessor() &&
        exists(/databases/$(database)/documents/courses/$(courseId)) &&
        get(/databases/$(database)/documents/courses/$(courseId)).data.professorId == request.auth.uid;
    }
    
    // Users collection - users can read/update their own profile
    // Allows sync from localStorage backup (merge operations)
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId); // Allows merge operations for sync
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Professors collection - allow authenticated users to access their own document
    // This allows initial setup before the user document exists in Firestore
    // Allows sync from localStorage backup (merge operations)
    match /professors/{professorId} {
      // Allow if user owns the document (professorId matches auth.uid)
      // This works even if the user document doesn't exist yet
      allow read: if isAuthenticated() && isOwner(professorId);
      allow create: if isAuthenticated() && request.auth.uid == professorId;
      allow update: if isAuthenticated() && isOwner(professorId); // Allows merge operations for sync
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Students collection - allow authenticated students to access their own document
    // Professors can read any student document (needed for studentId queries and data synchronization)
    // The document ID is the Firebase Auth UID, but the document contains a 'studentId' field (numerical)
    // This allows professors to query by numerical studentId field for data synchronization
    // Allows sync from localStorage backup (merge operations)
    match /students/{studentUid} {
      allow read: if isAuthenticated() && (isOwner(studentUid) || getUserRole() == 'Professor');
      allow create: if isAuthenticated() && request.auth.uid == studentUid;
      allow update: if isAuthenticated() && (isOwner(studentUid) || getUserRole() == 'Professor'); // Allows merge operations for sync
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Student Dashboards collection - students can read/update their own dashboard
    // Professors can read/update any student dashboard (for syncing data)
    // Allows sync from localStorage backup (merge operations)
    match /studentDashboards/{studentId} {
      allow read: if isAuthenticated() && (isOwner(studentId) || getUserRole() == 'Professor');
      allow create: if isAuthenticated() && (isOwner(studentId) || getUserRole() == 'Professor');
      allow update: if isAuthenticated() && (isOwner(studentId) || getUserRole() == 'Professor'); // Allows merge operations for sync
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Professor Dashboards collection - professors can read/update their own dashboard
    // Allows sync from localStorage backup (merge operations)
    match /professorDashboards/{professorId} {
      allow read: if isAuthenticated() && isOwner(professorId);
      allow create: if isAuthenticated() && request.auth.uid == professorId;
      allow update: if isAuthenticated() && isOwner(professorId); // Allows merge operations for sync
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Courses collection - professors can read/write their own courses, students can read enrolled courses
    // Allows sync from localStorage backup (merge operations)
    match /courses/{courseId} {
      // Professors can read courses where professorId matches their UID
      // For queries: resource.data is available for each matching document
      // For single reads: resource.data is also available
      allow read: if isAuthenticated() && (
        // Professors can read if professorId matches (works for both queries and single reads)
        (isProfessor() && resource.data.professorId == request.auth.uid) ||
        isStudent() // Students can read course info for enrolled courses (enrollment check done in app logic)
      );
      allow create: if isAuthenticated() && isProfessor() && request.resource.data.professorId == request.auth.uid;
      allow update: if isAuthenticated() && isProfessor() && (
        // Allow if course doesn't exist yet (creating) OR professor owns it
        (!exists(/databases/$(database)/documents/courses/$(courseId)) && request.resource.data.professorId == request.auth.uid) ||
        (resource.data.professorId == request.auth.uid)
      ); // Allows merge operations for sync
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Enrollments collection - students can read their own enrollments, professors can read enrollments for their courses
    // OPTIMIZED: Uses professorId field in document to avoid get() calls (reduces reads by 50-70%)
    // Allows sync from localStorage backup (merge operations)
    match /enrollments/{enrollmentId} {
      // Helper: Check if professor owns this enrollment (optimized - no get() call if professorId exists)
      function professorOwnsEnrollment() {
        // OPTIMIZATION: If professorId is stored in the document, use it directly (no get() call)
        return isAuthenticated() && isProfessor() && (
          resource.data.professorId == request.auth.uid ||
          request.resource.data.professorId == request.auth.uid
        );
      }
      
      // Students can read their own enrollments
      // Professors can read if professorId matches OR fallback to course check
      allow read: if isAuthenticated() && (
        isStudent() && (resource.data.studentId == request.auth.uid || request.resource.data.studentId == request.auth.uid) ||
        professorOwnsEnrollment() ||
        (isProfessor() && (
          professorTeachesCourse(resource.data.courseId) || 
          professorTeachesCourseFromRequest(request.resource.data.courseId)
        ))
      );
      // Professors can create enrollments for their courses
      // OPTIMIZED: Check professorId first, then fallback to course check
      allow create: if isAuthenticated() && isProfessor() && (
        request.resource.data.professorId == request.auth.uid ||
        professorTeachesCourseFromRequest(request.resource.data.courseId)
      );
      // Students can read their enrollments, professors can manage enrollments for their courses
      // Allows sync: professors can update enrollments for their courses (including merge operations)
      allow update: if isAuthenticated() && (
        isStudent() && (resource.data.studentId == request.auth.uid || request.resource.data.studentId == request.auth.uid) ||
        professorOwnsEnrollment() ||
        (isProfessor() && (
          professorTeachesCourse(resource.data.courseId) || 
          professorTeachesCourseFromRequest(request.resource.data.courseId)
        ))
      );
      // Only professors can delete enrollments for their courses
      allow delete: if isAuthenticated() && isProfessor() && (
        professorOwnsEnrollment() ||
        professorTeachesCourse(resource.data.courseId)
      );
    }
    
    // Grades collection - students can only read their own grades, professors can read grades for their courses
    // OPTIMIZED: Uses professorId field if available to avoid get() calls
    // Allows sync from localStorage backup (merge operations)
    match /grades/{gradeId} {
      // Helper: Check if professor owns this grade (optimized - no get() call if professorId exists)
      function professorOwnsGrade() {
        // OPTIMIZATION: If professorId is stored in the document, use it directly (no get() call)
        return isAuthenticated() && isProfessor() && (
          resource.data.professorId == request.auth.uid ||
          request.resource.data.professorId == request.auth.uid
        );
      }
      
      // Students can only read grades where studentId matches their UID
      // Professors can read if professorId matches OR fallback to course check
      allow read: if isAuthenticated() && (
        isStudent() && (resource.data.studentId == request.auth.uid || request.resource.data.studentId == request.auth.uid) ||
        professorOwnsGrade() ||
        (isProfessor() && (
          professorTeachesCourse(resource.data.courseId) || 
          professorTeachesCourseFromRequest(request.resource.data.courseId)
        ))
      );
      // Only professors can create/update grades for their courses
      // OPTIMIZED: Check professorId first, then fallback to course check
      allow create: if isAuthenticated() && isProfessor() && 
        request.resource.data.studentId != null && (
          request.resource.data.professorId == request.auth.uid ||
          professorTeachesCourseFromRequest(request.resource.data.courseId)
        );
      // Allows sync: professors can update grades for their courses (including merge operations)
      allow update: if isAuthenticated() && isProfessor() && (
        professorOwnsGrade() ||
        professorTeachesCourse(resource.data.courseId) || 
        professorTeachesCourseFromRequest(request.resource.data.courseId)
      );
      allow delete: if false; // Prevent deletion for data integrity (use soft delete if needed)
    }
    
    // Attendance collection - students can only read their own attendance, professors can read attendance for their courses
    // OPTIMIZED: Uses professorId field if available to avoid get() calls
    // Allows sync from localStorage backup (merge operations)
    match /attendance/{attendanceId} {
      // Helper: Check if professor owns this attendance (optimized - no get() call if professorId exists)
      function professorOwnsAttendance() {
        // OPTIMIZATION: If professorId is stored in the document, use it directly (no get() call)
        return isAuthenticated() && isProfessor() && (
          resource.data.professorId == request.auth.uid ||
          request.resource.data.professorId == request.auth.uid
        );
      }
      
      // Students can only read attendance where studentId matches their UID
      // Professors can read if professorId matches OR fallback to course check
      allow read: if isAuthenticated() && (
        isStudent() && (resource.data.studentId == request.auth.uid || request.resource.data.studentId == request.auth.uid) ||
        professorOwnsAttendance() ||
        (isProfessor() && (
          professorTeachesCourse(resource.data.courseId) || 
          professorTeachesCourseFromRequest(request.resource.data.courseId)
        ))
      );
      // Only professors can create/update attendance for their courses
      // OPTIMIZED: Check professorId first, then fallback to course check
      allow create: if isAuthenticated() && isProfessor() && 
        request.resource.data.studentId != null && (
          request.resource.data.professorId == request.auth.uid ||
          professorTeachesCourseFromRequest(request.resource.data.courseId)
        );
      // Allows sync: professors can update attendance for their courses (including merge operations)
      allow update: if isAuthenticated() && isProfessor() && (
        professorOwnsAttendance() ||
        professorTeachesCourse(resource.data.courseId) || 
        professorTeachesCourseFromRequest(request.resource.data.courseId)
      );
      allow delete: if false; // Prevent deletion for data integrity (use soft delete if needed)
    }
    
    // Attendance Sessions - enforce one attendance session per professor + course + date
    // Client should create docs in 'attendanceSessions' with ID pattern: {profUid}_{courseId}_{YYYY-MM-DD}
    match /attendanceSessions/{sessionId} {
      // Basic validation: ID must have three parts separated by "_"
      function isValidSessionId() {
        return sessionId.split('_').size() == 3;
      }

      // Professors can read their own sessions
      allow read: if isAuthenticated() && isProfessor();

      // Professors can create ONE session per day for a given course:
      // - user is authenticated and a Professor
      // - sessionId format is valid
      // - professorId in the document matches auth.uid
      // - a document with this ID does NOT already exist
      allow create: if isAuthenticated()
                    && isProfessor()
                    && isValidSessionId()
                    && request.resource.data.professorId == request.auth.uid
                    && !exists(/databases/$(database)/documents/attendanceSessions/$(sessionId));

      // Allow professor to update metadata of their own session if needed
      allow update: if isAuthenticated()
                    && isProfessor()
                    && resource.data.professorId == request.auth.uid;

      // Prevent deletion for integrity
      allow delete: if false;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}