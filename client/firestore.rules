rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to get user role from users collection (with safe error handling)
    // NOTE: Since heavy data is now in MySQL, Firestore is only for lightweight data
    function getUserRole() {
      return isOwner(request.auth.uid) 
        ? (exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
           ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role 
           : null)
        : null;
    }
    
    // Helper function to check if user is a student
    function isStudent() {
      return getUserRole() == 'Student';
    }
    
    // Helper function to check if user is a professor
    function isProfessor() {
      return getUserRole() == 'Professor';
    }
    
    // Users collection - users can read/update their own profile
    // NOTE: Heavy user data is in MySQL, this is for lightweight profile data only
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Professors collection - allow authenticated users to access their own document
    // NOTE: Heavy professor data is in MySQL, this is for lightweight profile data only
    match /professors/{professorId} {
      allow read: if isAuthenticated() && isOwner(professorId);
      allow create: if isAuthenticated() && request.auth.uid == professorId;
      allow update: if isAuthenticated() && isOwner(professorId);
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Students collection - allow authenticated students to access their own document
    // Professors can read any student document (needed for queries)
    // NOTE: Heavy student data is in MySQL, this is for lightweight profile data only
    match /students/{studentUid} {
      allow read: if isAuthenticated() && (isOwner(studentUid) || getUserRole() == 'Professor');
      allow create: if isAuthenticated() && request.auth.uid == studentUid;
      allow update: if isAuthenticated() && (isOwner(studentUid) || getUserRole() == 'Professor');
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Student Dashboards collection - DEPRECATED: Heavy data now in MySQL
    // Kept for backward compatibility only - should not be used for new data
    // NOTE: All heavy academic data (grades, attendance, enrollments) is now in MySQL
    match /studentDashboards/{studentId} {
      allow read: if isAuthenticated() && (isOwner(studentId) || getUserRole() == 'Professor');
      allow create: if isAuthenticated() && (isOwner(studentId) || getUserRole() == 'Professor');
      allow update: if isAuthenticated() && (isOwner(studentId) || getUserRole() == 'Professor');
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Professor Dashboards collection - DEPRECATED: Heavy data now in MySQL
    // Kept for backward compatibility only - should not be used for new data
    match /professorDashboards/{professorId} {
      allow read: if isAuthenticated() && isOwner(professorId);
      allow create: if isAuthenticated() && request.auth.uid == professorId;
      allow update: if isAuthenticated() && isOwner(professorId);
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Courses collection - DEPRECATED: Heavy data now in MySQL
    // Kept for backward compatibility only - should not be used for new data
    // NOTE: All course data is now in MySQL. This is kept for migration/backup purposes only.
    match /courses/{courseId} {
      allow read: if isAuthenticated() && (
        (isProfessor() && resource.data.professorId == request.auth.uid) ||
        isStudent()
      );
      allow create: if isAuthenticated() && isProfessor() && request.resource.data.professorId == request.auth.uid;
      allow update: if isAuthenticated() && isProfessor() && (
        (!exists(/databases/$(database)/documents/courses/$(courseId)) && request.resource.data.professorId == request.auth.uid) ||
        (resource.data.professorId == request.auth.uid)
      );
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Enrollments collection - DEPRECATED: Heavy data now in MySQL
    // Kept for backward compatibility only - should not be used for new data
    // NOTE: All enrollment data is now in MySQL. This is kept for migration/backup purposes only.
    match /enrollments/{enrollmentId} {
      function professorOwnsEnrollment() {
        return isAuthenticated() && isProfessor() && (
          resource.data.professorId == request.auth.uid ||
          request.resource.data.professorId == request.auth.uid
        );
      }
      
      allow read: if isAuthenticated() && (
        isStudent() && (resource.data.studentId == request.auth.uid || request.resource.data.studentId == request.auth.uid) ||
        professorOwnsEnrollment() ||
        (isProfessor() && (
          exists(/databases/$(database)/documents/courses/$(resource.data.courseId)) &&
          get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.professorId == request.auth.uid
        ))
      );
      allow create: if isAuthenticated() && isProfessor() && (
        request.resource.data.professorId == request.auth.uid ||
        (exists(/databases/$(database)/documents/courses/$(request.resource.data.courseId)) &&
         get(/databases/$(database)/documents/courses/$(request.resource.data.courseId)).data.professorId == request.auth.uid)
      );
      allow update: if isAuthenticated() && (
        isStudent() && (resource.data.studentId == request.auth.uid || request.resource.data.studentId == request.auth.uid) ||
        professorOwnsEnrollment() ||
        (isProfessor() && (
          exists(/databases/$(database)/documents/courses/$(resource.data.courseId)) &&
          get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.professorId == request.auth.uid
        ))
      );
      allow delete: if isAuthenticated() && isProfessor() && (
        professorOwnsEnrollment() ||
        (exists(/databases/$(database)/documents/courses/$(resource.data.courseId)) &&
         get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.professorId == request.auth.uid)
      );
    }
    
    // Grades collection - DEPRECATED: Heavy data now in MySQL
    // Kept for backward compatibility only - should not be used for new data
    // NOTE: All grade data is now in MySQL. This is kept for migration/backup purposes only.
    match /grades/{gradeId} {
      function professorOwnsGrade() {
        return isAuthenticated() && isProfessor() && (
          resource.data.professorId == request.auth.uid ||
          request.resource.data.professorId == request.auth.uid
        );
      }
      
      allow read: if isAuthenticated() && (
        isStudent() && (resource.data.studentId == request.auth.uid || request.resource.data.studentId == request.auth.uid) ||
        professorOwnsGrade() ||
        (isProfessor() && (
          exists(/databases/$(database)/documents/courses/$(resource.data.courseId)) &&
          get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.professorId == request.auth.uid
        ))
      );
      allow create: if isAuthenticated() && isProfessor() && 
        request.resource.data.studentId != null && (
          request.resource.data.professorId == request.auth.uid ||
          (exists(/databases/$(database)/documents/courses/$(request.resource.data.courseId)) &&
           get(/databases/$(database)/documents/courses/$(request.resource.data.courseId)).data.professorId == request.auth.uid)
        );
      allow update: if isAuthenticated() && isProfessor() && (
        professorOwnsGrade() ||
        (exists(/databases/$(database)/documents/courses/$(resource.data.courseId)) &&
         get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.professorId == request.auth.uid)
      );
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Attendance collection - DEPRECATED: Heavy data now in MySQL
    // Kept for backward compatibility only - should not be used for new data
    // NOTE: All attendance data is now in MySQL. This is kept for migration/backup purposes only.
    match /attendance/{attendanceId} {
      function professorOwnsAttendance() {
        return isAuthenticated() && isProfessor() && (
          resource.data.professorId == request.auth.uid ||
          request.resource.data.professorId == request.auth.uid
        );
      }
      
      allow read: if isAuthenticated() && (
        isStudent() && (resource.data.studentId == request.auth.uid || request.resource.data.studentId == request.auth.uid) ||
        professorOwnsAttendance() ||
        (isProfessor() && (
          exists(/databases/$(database)/documents/courses/$(resource.data.courseId)) &&
          get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.professorId == request.auth.uid
        ))
      );
      allow create: if isAuthenticated() && isProfessor() && 
        request.resource.data.studentId != null && (
          request.resource.data.professorId == request.auth.uid ||
          (exists(/databases/$(database)/documents/courses/$(request.resource.data.courseId)) &&
           get(/databases/$(database)/documents/courses/$(request.resource.data.courseId)).data.professorId == request.auth.uid)
        );
      allow update: if isAuthenticated() && isProfessor() && (
        professorOwnsAttendance() ||
        (exists(/databases/$(database)/documents/courses/$(resource.data.courseId)) &&
         get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.professorId == request.auth.uid)
      );
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Attendance Sessions - lightweight real-time data (can stay in Firestore)
    match /attendanceSessions/{sessionId} {
      function isValidSessionId() {
        return sessionId.split('_').size() == 3;
      }

      allow read: if isAuthenticated() && isProfessor();
      allow create: if isAuthenticated()
                    && isProfessor()
                    && isValidSessionId()
                    && request.resource.data.professorId == request.auth.uid
                    && !exists(/databases/$(database)/documents/attendanceSessions/$(sessionId));
      allow update: if isAuthenticated()
                    && isProfessor()
                    && resource.data.professorId == request.auth.uid;
      allow delete: if false;
    }
    
    // Activity Logs - lightweight real-time data (can stay in Firestore)
    match /activityLogs/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false; // Logs are immutable
      allow delete: if false; // Prevent deletion for data integrity
    }
    
    // Notifications - lightweight real-time data (can stay in Firestore)
    // NOTE: MySQL also has notifications table, but Firestore can be used for real-time updates
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        request.resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && request.resource.data.userId != null;
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        request.resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

